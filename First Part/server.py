import os
import socket

def receive_data(s):
        taille = ""
        data = b""
        flag = True
        while flag:
                ch = s.recv(1).decode()
                if(ch == "#"):
                        flag = False
                else:
                        taille += ch
        print(int(taille))
        for i in range(int(taille)):
                data += s.recv(1)  
        return data
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind(("127.0.0.1", 1234))
s.listen()
conn, addr = s.accept()
while True:
        data = conn.recv(1024)
        if not data:
                print("NETWORK ERROR")
                exit()
        data = data.decode()
        if(data == "LIST"):
                
                path = conn.recv(1024)
                path = path.decode()
                toret = "#### FILE LIST ####\n"
                j = 0
                for file in os.listdir(path):
                        toret += "[" + str(j) + "]" + file + "\n"
                        j += 1
                conn.sendall((str(len(toret)) + "#" + toret).encode())
        elif(data == "DOWNLOAD"):
                path = conn.recv(1024)
                path = path.decode()
                with open(path, 'rb') as f:
                        file_content = f.read()
                print(str(len(file_content)) + "#" + str(file_content))
                print(type(file_content))
                
                conn.sendall((str(len(file_content)) + "#" ).encode() + file_content)
        elif(data == "UPLOAD"):
                path = conn.recv(1024)
                filename = path.decode()
                print(filename)
                content = receive_data(conn)
                with open(filename, 'wb') as f:
                        f.write(content)